---
title: "temp"
author: "Lisa OConnell"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
__Endpoint Pathways:__  
-  Company Summaries: http://api.census.gov/data/2020/abscs   
-  Characteristics of Business: https://api.census.gov/data/2020/abscb  
*Additional Endpoints Available*  
Two additional endpoints are available, but are not used in this vignette:  
-  Characteristics of Business Owners: https://api.census.gov/data/2020/abscbo  
- Module Business Characteristics: https://api.census.gov/data/2020/absmcb  

```{r}
library(tidyverse)
library(httr)
library(jsonlite)
```

Access the Company Summaries Endpoint

```{r global}
#Numeric Variables in each endpoint
abscs_numeric_vars<-c("EMP", "FIRMPDEMP", "PAYANN", "RCPPDEMP")
```



Function to Retrieve
```{r}
amtst<-GET("https://api.census.gov/data/2020/abscs?get=GEO_ID,NAME,NAICS2017,NAICS2017_LABEL,SEX,SEX_LABEL,ETH_GROUP,ETH_GROUP_LABEL,RACE_GROUP,RACE_GROUP_LABEL,VET_GROUP,VET_GROUP_LABEL,EMPSZFI,EMPSZFI_LABEL,YEAR,FIRMPDEMP,FIRMPDEMP_F,RCPPDEMP,RCPPDEMP_F,EMP,EMP_F,PAYANN,PAYANN_F,FIRMPDEMP_S,FIRMPDEMP_S_F,RCPPDEMP_S,RCPPDEMP_S_F,EMP_S,EMP_S_F,PAYANN_S,PAYANN_S_F&for=us:*&key=324a30368aa24fca02eb737c15d7c32c63c891cb")
status_code(amtst)
#Query Format:
CBQ2<-GET("https://api.census.gov/data/2020/abscs?get=GEO_ID,NAME,RCPSZFI,NAICS2017_LABEL,SEX,SEX_LABEL,ETH_GROUP,ETH_GROUP_LABEL,RACE_GROUP,RACE_GROUP_LABEL,VET_GROUP,VET_GROUP_LABEL,EMPSZFI,EMPSZFI_LABEL,YEAR,FIRMPDEMP,EMP,PAYANN&for=us:*&NAICS2017=71&key=324a30368aa24fca02eb737c15d7c32c63c891cb")

```


```{r getwithQueries}

#Request data (resource) from the endpoint
#Include desired return variables and 
#and data filters (for=)

#GetData<- function (filepath)

  
CBQ<-GET("https://api.census.gov/data/2020/abscs?get=GEO_ID,NAME,RCPSZFI,NAICS2017,NAICS2017_LABEL,SEX,SEX_LABEL,ETH_GROUP,ETH_GROUP_LABEL,RACE_GROUP,RACE_GROUP_LABEL,VET_GROUP,VET_GROUP_LABEL,EMPSZFI,EMPSZFI_LABEL,YEAR,FIRMPDEMP,FIRMPDEMP_F,RCPPDEMP,RCPPDEMP_F,EMP,EMP_F,PAYANN,PAYANN_F,FIRMPDEMP_S,FIRMPDEMP_S_F,RCPPDEMP_S,RCPPDEMP_S_F,EMP_S,EMP_S_F,PAYANN_S,PAYANN_S_F&for=us:*&NAICS2017=71*&key=324a30368aa24fca02eb737c15d7c32c63c891cb")

#Check request successful via code
status_code(CBQ)
#Get data to parse
q1<-content(CBQ,as="parsed", encoding="UTF-8")
q11<-fromJSON(rawToChar(CBQ$content))
q111<-as_tibble(q11)

#Get variable names from the first row of data
var_names<-slice(q111,1)
b<-pivot_longer(var_names, cols=1:34,values_to = "new_name", names_to="old_name")
#Replace variable names
my_names<-b$new_name
my_names


#dimnames(my_ChB)[[2]]<-my_names
colnames(q111)<-my_names
#Remove the column name header row
q1111<-q111[-1, ]






```

Function to Change variable types  
- There are 4 interger variables of interest in the Company Summaries endpoint:  
 *EMP*: Number of employees  
 *FIRMPDEMP*: The number of employer firms  
 *PAYANN*: The annual payroll  
 *RCPPDEMP*: Sales, shipments or revenue in ($000s)  
 

```{r ConvertVarType}

ConvertVars<- function(my_df, endpoint, my_vars ) {

 if (source= "CS"){

   
 }
}
```



```{r}

CV<-function(my_df,endpoint) {
#Check User Input for valid values.
if (!(endpoint %in% c("CS","CB", "BO"))){ stop("Check your input")}  
if (endpoint=="CS") { 
    a<- (sapply(my_df[ , c("EMP", "FIRMPDEMP", "PAYANN", "RCPPDEMP")], as.numeric) )
    b<- (select,my_df)
  
    }
  #sapply(my_df[ , c("EMP", "FIRMPDEMP", "PAYANN", "RCPPDEMP")], as.numeric) 
if (endpoint =="CB") 
      #sapply(my_df[ , c("EMP", "FIRMPDEMP", "PAYANN", "RCPPDEMP")], as.numeric) } 
return(invisible(my_df))  
}  
  
```

```{r}
CV2<-function(my_df,endpoint) {
#Check User Input for valid values.
if_else (endpoint=="CS"),  
 
  
       (sapply(my_df[ , c("EMP", "FIRMPDEMP", "PAYANN", "RCPPDEMP")], as.numeric) ),  
   (if_else (endpoint =="CB"), sapply(my_df[ , c("EMP", "FIRMPDEMP", "PAYANN", "RCPPDEMP")], as.numeric),
      stop("Check your input"))  
  
Return(invisble(my_df))  
}  
  
```


Access the Characteristics of Business Endpoint 

```{r}
char_biz_path<-c("https://api.census.gov/data/2020/abscb")
char_biz_test<-GET("https://api.census.gov/data/2020/abscb?get=GEO_ID,NAME,NAICS2017,NAICS2017_LABEL,SEX,SEX_LABEL,ETH_GROUP,ETH_GROUP_LABEL,RACE_GROUP,RACE_GROUP_LABEL,VET_GROUP,VET_GROUP_LABEL,QDESC,QDESC_LABEL,BUSCHAR,BUSCHAR_LABEL,YEAR,FIRMPDEMP,FIRMPDEMP_F,FIRMPDEMP_PCT,FIRMPDEMP_PCT_F,RCPPDEMP,RCPPDEMP_F,RCPPDEMP_PCT,RCPPDEMP_PCT_F,EMP,EMP_F,EMP_PCT,EMP_PCT_F,PAYANN,PAYANN_F,PAYANN_PCT,PAYANN_PCT_F,FIRMPDEMP_S,FIRMPDEMP_S_F,FIRMPDEMP_PCT_S,FIRMPDEMP_PCT_S_F,RCPPDEMP_S,RCPPDEMP_S_F,RCPPDEMP_PCT_S,RCPPDEMP_PCT_S_F,EMP_S,EMP_S_F,EMP_PCT_S,EMP_PCT_S_F,PAYANN_S,PAYANN_S_F,PAYANN_PCT_S,PAYANN_PCT_S_F&for=us:*&QDESC_LABEL=SPOUSES&key=324a30368aa24fca02eb737c15d7c32c63c891cb")
status_code(char_biz_test)

```



```{r}
#THiS READS IN VAR NAMES, but does not handle the [] line
ChBTest<-GET("https://api.census.gov/data/2020/abscs?get=GEO_ID,NAME,RCPSZFI,NAICS2017,NAICS2017_LABEL,SEX,SEX_LABEL,ETH_GROUP,ETH_GROUP_LABEL,RACE_GROUP,RACE_GROUP_LABEL,VET_GROUP,VET_GROUP_LABEL,EMPSZFI,EMPSZFI_LABEL,YEAR,FIRMPDEMP,FIRMPDEMP_F,RCPPDEMP,RCPPDEMP_F,EMP,EMP_F,PAYANN,PAYANN_F,FIRMPDEMP_S,FIRMPDEMP_S_F,RCPPDEMP_S,RCPPDEMP_S_F,EMP_S,EMP_S_F,PAYANN_S,PAYANN_S_F&for=us:*&NAICS2017=71*&key=324a30368aa24fca02eb737c15d7c32c63c891cb")

#Check Request successful via code
status_code(ChBTest)
#This method takes in the variable names but adds a [in first var and a ] in #last var.  
#To correct you have to trim data.
csv_test<-read_csv(ChBTest$content, col_names = TRUE)
my_ch_b %>% 
  
 #Remove the column name header row
mydata<-my_ChB[-1, ]
 
#   my_ChB %>% slice(2990:2994) %>% select(V33:V34)
```

```{r}
#THiS READS IN VAR NAMES, but does not handle the [] line
ChBQ1csv<-GET("https://api.census.gov/data/2020/abscs?get=GEO_ID,NAME,RCPSZFI,NAICS2017,NAICS2017_LABEL,SEX,SEX_LABEL,ETH_GROUP,ETH_GROUP_LABEL,RACE_GROUP,RACE_GROUP_LABEL,VET_GROUP,VET_GROUP_LABEL,EMPSZFI,EMPSZFI_LABEL,YEAR,FIRMPDEMP,FIRMPDEMP_F,RCPPDEMP,RCPPDEMP_F,EMP,EMP_F,PAYANN,PAYANN_F,FIRMPDEMP_S,FIRMPDEMP_S_F,RCPPDEMP_S,RCPPDEMP_S_F,EMP_S,EMP_S_F,PAYANN_S,PAYANN_S_F&for=us:*&NAICS2017=71*&key=324a30368aa24fca02eb737c15d7c32c63c891cb")

#Check Request successful via code
status_code(ChBQ1csv)
#This method takes in the variable names but adds a [in first var and a ] in #last var.  
#To correct you have to trim data.
csv_test<-read_csv(ChBQ1csv$content, col_names = TRUE)
my_ch_b %>% 
  
 #Remove the column name header row
mydata<-my_ChB[-1, ]
 
#   my_ChB %>% slice(2990:2994) %>% select(V33:V34)
```