---
title: "Census Bureau ABS API Vignette"
author: "Lisa O'Connell"
date: "`r Sys.Date()`"
output: github_document
  toc:TRUE
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction  
Data from the American Business Survey (ABS) conducted by the US Census Bureau is explored in this vignette. The purpose of the vignette is to demonstrate access to multiple endpoints within the ABS data using a several query parameters.  Additionally an Exploratory Data Analysis (EDA) is completed which includes both numeric and graphical summarizations.  This vignette was created and is shared using a GitHub repository and GitHub page.  


## Description of Data  
__Endpoints Over Time__  
The American Business Survey data represents aggregated responses from the ABS survey conducted in the prescribed year from the selected endpoint. The purpose of the ABS surveys are to provide a profile of businesses in America, with responses  tabulated across several classification categories. 

The ABS data accessed for this vignette represents the endpoints for the year 2021 which contains data from the 2020 survey.  Data from survey estimates for the years 2020-2018 are available.   


*Endpoint Pathways:*  
CS Data: - Company Summaries: http://api.census.gov/data/2020/abscs   
CB Data:-  Characteristics of Business: https://api.census.gov/data/2020/abscb  

  
*Additional Endpoints Available*  
An additional endpoint is available, but is not used in this vignette:  
  -  Characteristics of Business Owners: https://api.census.gov/data/2020/abscbo  
  - Module Business Characteristics: https://api.census.gov/data/2020/absmcb  

The ABS datasets contain summarized survey data from 2021 survey estimates.  Data is available at the US, state and statistical area levels. This vignette accesses data at the US level.   

Business data can be profiled using survey responses classifications related to the business owner including for example veteran stats, sex, & race.

Quantitative variables the endpoints accessed in this vignette include estimated number of employees, a count of responding firms and estimated annual payroll expenses.  


__Returned Data Format:__  
As described in the ["CENSUS Data API User Guide"](https://www.census.gov/content/dam/Census/data/developers/api-user-guide/api-guide.pdf) The American Business Survey data is returned through an API via a 2 dimensional JSON array formatted as shown below for 3 variables:  

[["EMP" ,"STATE", "PAYANN"]],  
["10000, "GA", "500000"],  
["5000, "TX", "650000"].... 

  As a result, a general function has not used to query all classifications in one data pull.  More sophisticated programming techniques may be able to improve the data access functions, improving the efficiency and streamlining this code.  


The ABS endpoints include records at various levels of aggregation. 

The ABS data use the North American Industry Code System (NAICS2017) values, with aggregations of data at the 4-digit, 3-digit, and 2 digit NAICS code.  


# Requirements: R Libraries  
The following libraries are used to process access and process data in R.  The `tidyverse` library provides a set of packages relevant for data tidying, wrangling, and data summarization.  The `httr` package provides functions for manipulating urls.  The `jsonlite`package provides functions transfer of json data.
The `pollster` package was included to faciliate cross tab summarizations of aggregated survey data. Finally, the `gghalves` package was included to create addtional graphing styles.  Select functions from `knitr` are used to create table output.

`library(tidyverse)`
`library(httr)`
`library(jsonlite)`
#pollster library added to handle aggregated data
`library(pollster)`
#gghalves for additional plotting
`library(gghalves)`


```{r libraries , warning=FALSE, echo=FALSE}
library(tidyverse)
library(httr)
library(jsonlite)
#pollster library added to handle aggregated data
library(pollster)
#gghalves for additional plotting
library(gghalves)
#Turn off scientific notation
options(scipen = 9999)
```

# Functions to Retrieve ABS Data

Several functions are created to facilitate data retrieval. These functions allow query arguments to be passed in to select specific results.  Several helper functions are created to support the data wrangling and cleaning process. 

Wrapper functions are created to tidy data once received from the API call.  



# Functions List 
API Path Functions:  
__CS_Data__   
`CSData` - A combined function to create an API path, wrangles data into tidy tibble. Arguments allow for modification of 2 values in the endpoint (veteran status and industry code), with a default of a wildcard to allow it to be used as needed.  

__CB Data__   
`CB_Path`  - Creates query path.  Four user query parameters are allowed - NCAICS code, Survey Question, Veteran Status, and Owner Sex.
`CB_Data`   - Retreives data from the Characteristics of Businesses endpoint.  

*Common Helper Functions*  
`ConvertData`   
`CreateTibble`   
`Wrangle`  
`DeAgto4`   
Additionally, a there are helper functions to modify the unique variables passed into each of the above functions to implicitly coerice variable types and create factors. 


## Query parameters: 

__NAICS2017__   The NAICS industry code is the primary subsetting variable for both datasets. It is from the 2017 NAICS table. The arguement for this queray parameter is labeled `industryCode=`. This value can take on any 2-4 digit representation of the NAICS table, using a "*" as a wildcard.

__VET_GROUP__ A categorical variable that returns the status of the business owner as a veteran.  The query parameter for this function arguement is `vetStatus=`, and cand take on the value, of vet, nonvet, both, all or a wildcard. 

__SEX__ - A categorical variable returning the sex of the business owner. This arguement is labeled `sex=` and can take on the value of male, female or all.

__Survey Questions__  Survey responses are captured in the survey questions variables.  There are several survey questions to choose from, so it is impractical for this vignette to code user friendly descriptions for all survey questions.  A table of the survey question codes and the answer codes can be found on the ABS website here: [https://www.census.gov/data/developers/data-sets/abs.html](https://www.census.gov/data/developers/data-sets/abs.html).   

This vignette focuses on survey question "B02" related to businesses being either family run or not family operated.  The aruguement for this survey question is `bizAttrib="B02"`.  


## Function Definitions  

__User friendly inputs for functions:__  
The following words are used as input to the functions. 

`vetstatus = "all"` both non vet and vet business owners  
`vetstatus = "vet"` vet business owners  
`vetStatus = "both"` equally vet/nonvet ownership  
`vetstatus = "none"`  non vet   

`sex=all` male, female and equal shared ownership  
`sex=female`female owners only  
`sex=male`male owners only  

*The user of these functions must know their industry code of interest and survey question of interest.*  

```{r CSData}

CSData<- function(vetStatus="all",industryCode="*") {
#* is a wildcard value

endpath <- "https://api.census.gov/data/2020/abscs?"

#A list of variable to return, excluding the query variables
varlist <- "get=FIRMPDEMP,PAYANN,EMP,RCPPDEMP,SECTOR,SUBSECTOR"

#Parse the user-friendly inputs

 switch(vetStatus, 
       vet = {vtStat<-"002"},
       nonvet = {vtStat<- "004"},
       mixed = {vtStat<- "003"},
       all = {vtStat<- "002&VET_GROUP=004&VET_GROUP=003"} )

#Paste query variables to path
path <- paste0(endpath,
              varlist,
              #A list of  query arguments
              "&for=us:*",
              "&NAICS2017=", industryCode,
              "&VET_GROUP=", vtStat, 
              "&key=324a30368aa24fca02eb737c15d7c32c63c891cb")

#Execute the API call 
raw_data <- GET(path)

#Print status code of returned data
a<-status_code(raw_data)
print(a)

my_df<-raw_data %>%
     Wrangle() %>% # A wrapper function
     #Modify variable types
     mutate(Firms = as.double(FIRMPDEMP),
            Revenue = as.double(RCPPDEMP),
            Payroll = as.double(PAYANN),
            Employees = as.double(EMP)) %>% 
     mutate(Industry = as.factor(NAICS2017), 
             SECTOR=as.factor(SECTOR), 
             SUBSECTOR= as.factor(SUBSECTOR),
             VET_GROUP= as.factor(VET_GROUP))
return(my_df)
}
```

```{r FxConvertData}
ConvertData<-function (myraw) {
  a1<-fromJSON(rawToChar(myraw$content))
  a2<-as_tibble(a1)
  invisible(a2)
}

```

```{r FxCreateTibble}
CreateTibble<-function(temp_df) {
  
#Create tibble 
temp_df<-as_tibble(temp_df)

#Get variable names from the first row of data
var_names<-slice(temp_df,1)
num_cols<-length(var_names)
  
b<-pivot_longer(var_names, 
                cols=1:num_cols,
                values_to = "new_name", 
                names_to="old_name")

#Replace variable names
my_names<-b$new_name

#Remove the column name header row
colnames(temp_df)<-my_names
new_data<-temp_df[-1, ]
  
#Return data in pipe form
invisible(new_data)
}
```

```{r WrangleWrapper}
Wrangle<- function(my_df){
  number_vars<-c("PAYANN", "FIRMPDEMP",  "EMP")     

    tidy_data <- my_df %>% 
       ConvertData() %>% 
       CreateTibble() %>% 
       DeAgto4() %>% 
       mutate(across(number_vars, as.double)) 
   invisible(tidy_data)
}

```

```{r FXDeaggregate}
#Removes aggregated records to leave only 4 digit NAICS codes.
#This is needed to remove duplicate rows reported in the raw data due to aggregation values
DeAgto4<-function (a_df) {

    a <- a_df %>%
        filter(((nchar(NAICS2017)) > 3) &
               ((substring(NAICS2017, 3,3)!="-")))
    invisible (a)
    }

```

```{r CB_Path}
CB_Path<- function(bizAttrib="B02", bizAnswer="*", vets="all", industryCode="*", sx="all") {

# For purpose of this demonstration, a default question is set for bizAttrib.


  endpath <- "https://api.census.gov/data/2020/abscb?"
  varlist <- "get=QDESC_LABEL,BUSCHAR_LABEL,EMP,FIRMPDEMP,PAYANN,RCPPDEMP,SECTOR,SUBSECTOR"

   switch(vets, 
       vet = {vtStat<-"002"},
       nonvet = {vtStat<- "004"},
       mixed = {vtStat<- "003"},
       all = {vtStat<- "002&VET_GROUP=004&VET_GROUP=003"})
     
   switch(sx, 
      all = {SEX <- "002&SEX=003&SEX=004"},
      male = {SEX <-"003"},
      female = {SEX<- "002"} )

  path <- paste0(endpath,varlist,
                "&for=us:*",
                "&NAICS2017=", industryCode,
                "&VET_GROUP=",vtStat,
                "&SEX=", SEX,
                "&QDESC=",bizAttrib,
                "&BUSCHAR=", bizAnswer,
                "&key=324a30368aa24fca02eb737c15d7c32c63c891cb")

}
```

```{r CB_Data}
CB_Data<- function (path) {

  rawcb <- GET(path)
   
#Print status code of returned data
   a<-status_code(rawcb)
   print(a)
  
#Tidy data
 
   my_df<-rawcb %>%
      Wrangle() %>%
       DeAgto4() %>% 
   #Modify variable types
   mutate(Firms = as.double(FIRMPDEMP),
            Revenue = as.double(RCPPDEMP),
            Payroll = as.double(PAYANN),
            Employees = as.double(EMP))     %>% 
     mutate(Industry = as.factor(NAICS2017), 
             SECTOR=as.factor(SECTOR), 
             SUBSECTOR= as.factor(SUBSECTOR),
             SEX= as.factor(SEX),
             BUSCHAR= as.factor(BUSCHAR),
             VET_GROUP= as.factor(VET_GROUP))
invisible(my_df)
  }

```

## Exploring the Company Summary Data  

### RQ1 - A Review of Veteran Owned Businesses  

The Company Summary endpoints allows us to profile businesses and business owners.   
I have chosen to access the endpoint to review business ownership by veterans across all industry secotrs.     

Let's get some data using my API functions:  

```{r RQ1DataSun, warning=FALSE }

#This represent 1 modification of the CS endpoint, extracting by Vet status
CS_AllVets<-CSData(vetStatus = "all", industryCode = "*")

#Return Status of API pull displayed
```

Lets look at the nature of the variables stored in the dataset, using the 5 number summaries for quantitative values.  
```{r warning=FALSE}
summary(CS_AllVets)
```
To explore teh overall presence of veteran owned firms across 
```{r RQ1Summaries  }

#Create summarized dataset 
BySector<-CS_AllVets %>%
   group_by(SECTOR,VET_GROUP) %>% 
   summarize(Firms = sum(Firms))

#Plot of veterans by sector

ggplot(BySector,aes(SECTOR, Firms)) +
  geom_col(fill= "#00AFBB")+
  theme_light()+
  labs(title="Count of Firms by NAICS Industry Sector",
       subtitle = "By Owner Veteran Status, 2=Veterans, 4=NonVeterans, 3=Joint =Ownership") +
   facet_wrap(~VET_GROUP)

```


The count of firms owned by veterans is quite small across all American Business.   

As the plot above shows, there are large concentrations of veterans in sector 23(Construction), 54(Scientific & Technincal Services), and 62 (Healthcare). Of course this is consistent with the overall size of the these sectors.   


## RQ2: An Exloration of the Transporation Industry - NAICS Sector 48  

Logistics and Transportation (Sector 48) is a growing area, and with that I was interesting in taking a look at this sector more closely.
First, let's pull some data using the `industryCode argument. The wildcard default is used for the veteran code.   

```{r RQ2DataSUN}

CS_48<-CSData(industryCode = "48*")

#A succesful data pull returns a code of 200
```

Now that we havewrangled and cleaned data, lets look at some numeric summaries using our veteran classification within the returned data. This time we will lookat the industries that make up the larger transporation sector. Subsectors are presented by 3 digit NAICS codes.   

First we will look at total firms, then total employees. As expected these distributions mirror one another.  Subsectors 488, Truck Transportation, and Subsector 485 stands out for further investigation.This is the sector for Urban Transit and Ground Transportation.

```{r RQ2Summaries}
#Count firms
CS_SubSectors<-CS_48 %>%      
    group_by(SUBSECTOR,VET_GROUP) %>% 
     summarize(TotFirms = sum(Firms))

#Show the distribution of business owners by veteran status

CS_SubSectorEmps<-CS_48 %>%      
    group_by(SUBSECTOR,VET_GROUP) %>% 
     summarize(TotEmps = sum(Employees))

#Plot Firms
ggplot(CS_SubSectors, aes(SUBSECTOR,TotFirms,fill=VET_GROUP))+
  geom_col()+
     labs(title="Total Firms by Veteran Classification in Transporation Sector",
         x= "Industry NAICS Sector 2017",
         y= ("Number of Firms")) +
         scale_fill_discrete(name="Veteran Status",
                             labels=c("Veterans", "Vet/NonVet Partners", "NonVeterans"))+
      theme_minimal()
  
#Plot Employees
  ggplot(CS_SubSectorEmps, aes(SUBSECTOR,TotEmps,fill=VET_GROUP))+
  geom_col()+
     labs(title="Total Employees by Veteran Classification in Transporation Sector",
         x= "Industry NAICS Sector 2017",
         y= ("Number of Employees")) +
         scale_fill_discrete(name="Veteran Status",
                             labels=c("Veterans", "Vet/NonVet Partners", "NonVeterans"))+
      theme_minimal()

```

Since the ABS data is aggregated, I have used both dplyr functions and alternatively functions from pollster to help create cross-tab tables.  

Let's look at those summaries of the number of firms owned by Veterans vs non by Sectors using crosstabs:  

```{r RQ2Crosstab, warning=FALSE}


a<-CS_48 %>% 
   group_by(SUBSECTOR,VET_GROUP) %>% 
   summarize(nFirms=sum(Firms)) %>% 
   spread(VET_GROUP,nFirms,sep="_") %>% 
   rename(NonVets= "VET_GROUP_002", "Vet/NonVet_Owners"= "VET_GROUP_003", "VETs" = "VET_GROUP_004") 
#Print the table

knitr::kable(a,caption="Crosstab Count of Firms by Veteran Status in Sector 48")
```

I decided to look at the pay rates within the transportation industry.  We can look to see if payrates  appear visually different to guide a deeper analysis. For this analysis, I will use the data for all vet owners. 


```{r RQ2PayRates, warning=FALSE}
#Using 4 digit codes
pay_df2<-CS_48 %>%
    mutate(AvgAnnualPay= (Payroll*1000)/Employees) %>% 
    filter(AvgAnnualPay!="NaN" & SUBSECTOR!="NA") 
 
ggplot(pay_df2,aes(x=VET_GROUP,y=AvgAnnualPay)) +
     geom_boxplot(fill="#00AFBB")+
      theme_minimal()+
      labs(title="Mean and Spread of Average Annual Pay in NACICS 48- Transporation Industry", 
           subtitle= "Shown by Businesses Owner Veteran Status",
            x="Veteran Status",
            y="Average Annual Pay") +
       scale_x_discrete(labels=(c("Veterans", "Co-Vet/NonVet", "NonVeterans")))

```

As the chart shows, the mean annual pay based on the data from 4-digit codes for all transportation businesses appears higher for veterans. This would suggest further investigation to the make of of the business in the individual 4 digit sectors to see if there are differences that is driving this result.

## RQ3 Exploration of Characteristics of Business (CB) Owners Data  

The CB dataset allows us to better understand key attributes of business owners, for example whether businesses are family owned or franchised. These can be accessed by querying the specific survey question and their corresponding answers.  Given the structure of the dataset, it is necessary to know the survey question number to access this information.  My focus will be on family business characteristics which are captured in the ABS survey question labeled __"B02"__.  

To explore family business ownership, I started by looking at the number of firms owned by families across industry sectors to see if some sectors have higher percentage of family businesses.  

First we must pull data from teh CB endpoint. I will use the wildcard * input for the NAICS code, and retrieve data survey results from question B02.
```{r fambysectordata}

familypath<-CB_Path(bizAttrib = "B02" )
fambiz<-CB_Data(familypath)

#A code of 200 is returned if data is retreived,
```

As the cross tablulation below shows, family owned businesses as a share of total sector business owners are highest in the NAICS sector 22 (accounting for 62% of owners, although the number of firms here is small), Sector 44, a much larger sector where family owners represent 36% or over 87,000 firms.  Similar high numbers of firms are in sectors, 53, and 56. 

```{r fambysectoranalysis}

fambiz2<- fambiz %>% 
       #Remove summary rows from aggregated data         
       filter(BUSCHAR %in% c("BM","BN")) 

t1<- pollster::crosstab(fambiz2, y=BUSCHAR_LABEL, x=SECTOR,weight=FIRMPDEMP)
knitr::kable(t1,caption = "Crosstab Summary of Percent Split of Family Owned Businesses by Sector")

```
To see the distribution of actual counts of firms by sector the following tables are produced:  
```{r}
#For Family Owned Businesses:
 BM<-fambiz2 %>% filter(BUSCHAR == "BM")
 BN<-fambiz2 %>% filter(BUSCHAR == "BN")
# 
#Use pollster function to display crosstables
#For Family Owned Businesses:
t2<-pollster::topline(BM, variable =SECTOR,weight=FIRMPDEMP, valid_pct = FALSE,cum_pct = FALSE)
knitr::kable(t2, caption ="Count of Family Owned Businesses by Sector")

# #For Non-Family Owned Businesses
t3<-pollster::topline(BN, variable =SECTOR,weight=FIRMPDEMP, valid_pct = FALSE,cum_pct = FALSE)
knitr::kable(t3, caption ="Count NonFamlily Owned Businesses by Sector")
```

__Family Business by Sex__  
To allow for another look at the data, we are able to split the data further by sex, to see if there are notable differences overall in the number of family owned businesses by owner sex. 

Lets explore the number of family owned vs non-family owned businesses by owner sex (as defined as male, female, or equally share of owndership (male and female).    

```{r FamOwnershipBySex}

# #Display Crosstab
ft1<-pollster::crosstab(fambiz2, y=SEX, x=SECTOR,weight=FIRMPDEMP)
ft1<-ft1 %>% rename("Females"="002", "Males"= "004", "Mixed"="003")

knitr::kable(ft1,caption="Overall split of Family Owned Businesses by Sex" )

#Since we have aggregated data and some geoms do not allow 
#for stat=identity parameters,I unwieght the aggregated
#data for the geom_count plot. 

b<-fambiz2%>% 
 uncount(weights=.$Firms)

#Plot the difference in the number of firms owned by sex
ggplot(b,aes(SEX,SECTOR)) +
  geom_count(color="magenta") +
  labs(title= "Family Business Ownership by Sector & Owner Sex",
       subtitle = "Dot Size Represents Relative # Firms",
       x= "Owner Sex",
       y= "Sector")+
    scale_x_discrete(labels=(c("Female", "Male", "Joint Owned Male/Female"))) +
    theme_light()


```
Let's look at some cross tab tables:  
```{r}
fam3<-fambiz2 %>%
    select(SECTOR,SUBSECTOR, FIRMPDEMP,EMP,BUSCHAR, everything()) %>%
     group_by(SECTOR,SEX,BUSCHAR) %>%
    summarize(Firms = sum(FIRMPDEMP))
   
#Tables
#
t6<-pollster::crosstab_3way(fam3, y=BUSCHAR, x=SECTOR,z=SEX, weight=Firms, format = "wide")
t6<-t6 %>% rename("Family Firms"="BM", "NonFamilyFirms" = "BN")
knitr::kable(t6, caption = "Split of Firms by Sector, Sex and Business Classification")

```

__Transporation and Family Owned Businesses__
Let's go back to the transportation sector and evaluate family owned businesses.   

For demonstration purposes, lets again pull family business data down from the CB endpoint again, this time using the veteran status modifier, and industry code. We will filter the data to remove the high level aggregation rows present in this data (e.g. stratification totals, classifiable, unclassifiable counts)

```{r}
CB_48path<-CB_Path(vets = "all", industryCode = "48*", bizAttrib = "B02")
CB_48Data<-CB_Data(CB_48path)

#Filter to remove aggregation rows
CB_48Data<-CB_48Data %>% 
 filter(BUSCHAR %in% c("BM","BN")) 

```
Let's see how veterans owners are presented across family business classifications.Let's summarize the frequency of ownership by Vet Status and Family Business status.  

```{r}

tt<-pollster::crosstab(CB_48Data, x=BUSCHAR_LABEL, y=VET_GROUP,weight=FIRMPDEMP)

tt <- tt %>%  rename("NonVets" = "002", "Mixed Ownership" = "003", "Vets"= "002")
knitr::kable(tt, title="Crosstabulation By Business Type (Family/Not Family Owned) and Veteran Status of Owners")

```

No let's  visualize graphically this stratification of the Transportation Industry data. 

```{r}
# temp_df <-CB_48Data %>% 
#            group_by(BUSCHAR,VET_GROUP) %>% 
#            summarize(TotFirms = sum(FIRMPDEMP),
#                      AvgAnnPayrollinThs= sum(PAYANN),
#                      TotEmps= sum(EMP))
# 
# 
# knitr::kable(temp_df,title="Stratification of Family Businesses by Owner Veteran Status ")
# 
# 
# #Show graphically
# 
# b<-CB_48Data%>% 
#  uncount(weights=.$Firms)
# 
# ggplot(CB_48Data, aes(VET_GROUP,BUSCHAR),color="blue") +
#  geom_jitter() +
#   labs(title= "Family Business Ownership by Veteran Status",
#        subtitle = "Dots  # Firms",
#        x= "Owner Veteran Status",
#        y= "Business Type") 
#   
#   #  scale_x_discrete(labels=(c("Female", "Male", "Joint Owned Male/Female")))
# 
# 
# ggplot(CS_48Data, aes(x=BUSCHAR,y=Firms)) 
# t48g7+ geom_half_boxplot(side="l", center = TRUE, outlier.color = "blue") +
#  geom_half_point() +
#  # facet_wrap(~VET_GROUP)
#   #theme_light()

```
