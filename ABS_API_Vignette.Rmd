---
title: "Census Bureau ABS API Vignette"
author: "Lisa OConnell"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


REMEMBER TO CHANGE THE OUTPUT TYPE above AND CREATE RMD files

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction  
Data from the American Business Survey (ABS) conducted by the US CENSUS Bureau is explored in this vignette. The purpose of the vignette is to demonstrate access to multiple endpoints within the ABS data using a several query parameters.  Additionally an Exploratory Data Analysis (EDA) is completed which includes both numeric and graphical summarizations.  This vignette was created and is shared using a GitHub repository and GitHub page.  


## Description of Data  
__Endpoints Over Time__  
The American Business Survey data represents aggregated responses from the ABS survey conducted in the prescribed year from the selected endpoint. The purpose of the ABS surveys are to provide a profile of businesses in America, with responses  tabulated across several classification categories. 

The ABS data accessed for this vignette represents the endpoints for the year 2021 which contains data from the 2020 survey.  Data from survey estimates for the years 2020-2018 are available.   


*Endpoint Pathways:*  
CS Data: - Company Summaries: http://api.census.gov/data/2020/abscs   
CB Data:-  Characteristics of Business: https://api.census.gov/data/2020/abscb  

  
*Additional Endpoints Available*  
An additional endpoint is available, but is not used in this vignette:  
  -  Characteristics of Business Owners: https://api.census.gov/data/2020/abscbo  
  - Module Business Characteristics: https://api.census.gov/data/2020/absmcb  

The ABS datasets contain summarized survey data from 2021 survey estimates.  Data is available at the US, state and statistical area levels. This vignette accesses data at the US level.   

Business data can be profiled using survey responses classifications related to the business owner including for example veteran stats, sex, & race.

Quantitative variables the endpoints accessed in this vignette include estimated number of employees, a count of responding firms and estimated annual payroll expenses.  


__Returned Data Format:__  
As described in the ["CENSUS Data API User Guide"](https://www.census.gov/content/dam/Census/data/developers/api-user-guide/api-guide.pdf) The American Business Survey data is returned through an API via a 2 dimensional JSON array formatted as shown below for 3 variables:  

[["EMP" ,"STATE", "PAYANN"]],  
["10000, "GA", "500000"],  
["5000, "TX", "650000"].... 

  As a result, a general function has not used to query all classifications in one data pull.  More sophisticated programming techniques may be able to improve the data access functions, improving the efficiency and streamlining this code.  



# Requirements: R Libraries  
The following libraries are used to process access and process data in R.  The `tidyverse` library provides a set of packages relevant for data tidying, wrangling, and data summarization.  The `httr` package provides functions for manipulating urls.  The `jsonlite`package provides functions transfer of json data.
The `pollster` package was included to faciliate cross tab summarizations of aggregated survey data. Finally, the `gghalves` package was included to create addtional graphing styles.  Select functions from `knitr` are used to create table output.


```{r libraries , warning=FALSE, echo=FALSE}
library(tidyverse)
library(httr)
library(jsonlite)
#pollster library added to handle aggregated data
library(pollster)
#gghalves for additional plotting
library(gghalves)
#Turn off scientific notation
options(scipen = 9999)
```

# Functions to Retrieve ABS Data

Several functions are created to facilitate data retrieval. These functions allow query arguments to be passed in to select specific results.  Several helper functions are created to support the data wrangling and cleaning process. 

Wrapper functions are created to tidy data once received from the API call.  

Due the the nature of the data returned through the API, which includes records at various levels of aggregation, I found it easier to execute a call for the data needed through the API, rather than undertaking extensive  wrangling in R.   This produced more reliable easier to follow datasets, although there is some redundant code in the path and wrangle sections.  I believe this may be remedied with more sophisticated functions to handle the variance in the variables requested and returned.   

The ABS data use the North American Industry Code System (NAICS2017) values as the highest level of aggregation.   

# Functions List 
API Path Functions:  
__CS_Data__ 
`CSData` - A combined function to create an API path, wrangles data into tidy tibble. Arguments allow for modification of 2 values in the endpoint (veteran status and industry code), with a default of a wildcard to allow it to be used as needed.  

__CB Data__  
`CB_Path` 
`CB_Data` - Retreives data from the Company Summaries endpoint.These funciton allows for modification of 2 values on the endpoint - industry code and veteran status.   
A series of functions are created to access the characteristics of Business Endpoint. Again, in the future, it would be useful to consolidate these funcitons.  `

*Common Helper Functions*  
`ConvertData`   
`CreateTibble`   
`Wrangle`  
`DeAgto4`   
Additionally, a there are helper functions to modify the unique variables passed into each of the above functions to implicitly coerice variable types and create factors. 


## Query parameters: 

__NAICS2017__   The NAICS industry code is the primary subsetting variable for both datasets. It is from the 2017 NAICS table. The arguement for this queray parameter is labeled `industryCode=`. This value can take on any 2-4 digit representation of the NAICS table, using a "*" as a wildcard.

__VET_GROUP__ A categorical variable that returns the status of the business owner as a veteran.  The query parameter for this function arguement is `vetStatus=`, and cand take on the value, of vet, nonvet, both, all or a wildcard. 

__SEX__ - A categorical variable returning the sex of the business owner. This arguement is labeled `sex=` and can take on the value of male, female or all.

__Survey Questions__  Survey responses are captured in the survey questions variables.  There are several survey questions to choose from, so it is impractical for this vignette to code user friendly descriptions for all survey questions.  A table of the survey question codes and the answer codes can be found on the ABS website here: [https://www.census.gov/data/developers/data-sets/abs.html](https://www.census.gov/data/developers/data-sets/abs.html).   

This vignette focuses on survey question "B02" related to businesses being either family run or not family operated.  The aruguement for this survey question is `bizAttrib=`.  



## Function Definitions  

__User friendly inputs for functions:__  
The following words are used as input to the functions. 

`vetstatus = "all"` both non vet and vet business owners
`vetstatus = "vet"` vet business owners
`vetStatus = "both"` equally vet/nonvet ownership
`vetstatus = "none"`  non vet 

`sex=all` male, female and equal shared ownership
`sex=female`female owners only
`sex=male`male owners only



```{r CSData}

CSData<- function(vetStatus="all",industryCode="*") {
#defaults are wildcard values

#Defaults used to pull these variables when not specified by user. 
endpath <- "https://api.census.gov/data/2020/abscs?"
#A list of variable to return, excluding the query variables
varlist <- "get=FIRMPDEMP,PAYANN,EMP,RCPPDEMP,SECTOR,SUBSECTOR"

#Parse the user-friendly 

 switch(vetStatus, 
       vet = {vtStat<-"002"},
       nonvet = {vtStat<- "004"},
       mixed = {vtStat<- "003"},
       all = {vtStat<- "002&VET_GROUP=004&VET_GROUP=003"} )

#Paste query variables to path
path <- paste0(endpath,
              varlist,
            #A list of potential query arguments
              "&for=us:*",
              "&NAICS2017=",
               industryCode,
              "&VET_GROUP=",
               vtStat, 
              "&key=324a30368aa24fca02eb737c15d7c32c63c891cb")
 
raw_data <- GET(path)
#Print status code of returned data
a<-status_code(raw_data)
print(a)
my_df<-raw_data %>%
     Wrangle() %>%
     #Modify variable types
     mutate(Firms = as.double(FIRMPDEMP),
            Revenue = as.double(RCPPDEMP),
            Payroll = as.double(PAYANN),
            Employees = as.double(EMP)) %>% 
     mutate(Industry = as.factor(NAICS2017), 
             SECTOR=as.factor(SECTOR), 
             SUBSECTOR= as.factor(SUBSECTOR),
             VET_GROUP= as.factor(VET_GROUP))
return(my_df)

}
```

```{r FxConvertData}
ConvertData<-function (myraw) {
  a1<-fromJSON(rawToChar(myraw$content))
  a2<-as_tibble(a1)
  invisible(a2)
}

```

```{r FxCreateTibble}
CreateTibble<-function(temp_df) {
  
#Create tibble 
temp_df<-as_tibble(temp_df)

#Get variable names from the first row of data
var_names<-slice(temp_df,1)
num_cols<-length(var_names)
  
b<-pivot_longer(var_names, 
                cols=1:num_cols,
                values_to = "new_name", 
                names_to="old_name")

#Replace variable names
my_names<-b$new_name

#Remove the column name header row
colnames(temp_df)<-my_names
new_data<-temp_df[-1, ]
  
#Return data in pipe form
invisible(new_data)
}
```

```{r WrangleWrapper}
Wrangle<- function(my_df){
  number_vars<-c("PAYANN", "FIRMPDEMP",  "EMP")     

    tidy_data <- my_df %>% 
       ConvertData() %>% 
       CreateTibble() %>% 
       DeAgto4() %>% 
       mutate(across(number_vars, as.double)) 
   invisible(tidy_data)
}

```

```{r FXDeaggregate}
#Removes aggregated records to leave only 4 digit NAICS codes.
#This is needed to remove duplicate counts that can occur when the wildcard* is used.
DeAgto4<-function (a_df) {

    a <- a_df %>%
        filter(((nchar(NAICS2017)) > 3) &
               ((substring(NAICS2017, 3,3)!="-")))
    invisible (a)
    }

```

```{r CB_Path}
CB_Path<- function(bizAttrib="B02", bizAnswer="*", vets="all", industryCode="*", sx="all") {

  #if (bizAttrib="999")  {stop("Please pick a survey question")}

  endpath <- "https://api.census.gov/data/2020/abscb?"
  varlist <- "get=QDESC_LABEL,BUSCHAR_LABEL,EMP,FIRMPDEMP,PAYANN,RCPPDEMP,SECTOR,SUBSECTOR"

   switch(vets, 
       vet = {vtStat<-"002"},
       nonvet = {vtStat<- "004"},
       mixed = {vtStat<- "003"},
       all = {vtStat<- "002&VET_GROUP=004&VET_GROUP=003"})
     
   switch(sx, 
      all = {SEX <- "002&SEX=003&SEX=004"},
      male = {SEX <-"003"},
      female = {SEX<- "002"} )

  path <- paste0(endpath,varlist,
                "&for=us:*",
                "&NAICS2017=", industryCode,
                "&VET_GROUP=",vtStat,
                "&SEX=", SEX,
                "&QDESC=",bizAttrib,
                "&BUSCHAR=", bizAnswer,
                "&key=324a30368aa24fca02eb737c15d7c32c63c891cb")

}
```

```{r CB_Data}
CB_Data<- function (path) {

  rawcb <- GET(path)
   
#Print status code of returned data
   a<-status_code(rawcb)
   print(a)
  
#Tidy data
 
   my_df<-rawcb %>%
      Wrangle() %>%
       DeAgto4() %>% 
   #Modify variable types
   mutate(Firms = as.double(FIRMPDEMP),
            Revenue = as.double(RCPPDEMP),
            Payroll = as.double(PAYANN),
            Employees = as.double(EMP))     %>% 
     mutate(Industry = as.factor(NAICS2017), 
             SECTOR=as.factor(SECTOR), 
             SUBSECTOR= as.factor(SUBSECTOR),
             SEX= as.factor(SEX),
             VET_GROUP= as.factor(VET_GROUP))
invisible(my_df)
  }

```

## Exploring the Company Summary Data  

### RQ1 - Review of Vet Owned Businesses
The company summary endpoints allows us to profile businesses and business owners. 
I have chosen to access the endpoint to review business ownsership by veterans across all industy secotrs.   

```{r RQ1DataSun, warning=FALSE }

#This represent 1 modification of the CS endpoint, extracting by Vet status
CS_AllVets<-CSData(vetStatus = "all", industryCode = "*")

#Return Status of API pull displayed
```

Lets look at the nature of the variables stored in the dataset, along with 5 number summaries for quatitative values:
```{r warning=FALSE}

summary(CS_AllVets)

```

```{r RQ1SummariesSUN}

#Create summarized dataset 
VetsBySector<-CS_AllVets %>%
   group_by(SECTOR,VET_GROUP) %>% 
   summarize(Firms = sum(Firms))

#Plot of veterans by sector

ggplot(VetsBySector,aes(SECTOR, Firms)) +
  geom_col(fill= "#00AFBB")+
  theme_light()+
  labs(title="Count of Firms Owned by Veterans by NAICS Industry Sector")
```


As the plot above shows, there are large concentrations of veterans in sector 23(Construction), 54(Scientific & Technincal Services), and 62 (Healthcare). Of course this is consistent with the overall size of the these sectors.   


#RQ2: Pull Data within the Transporation Industry  

Logistics and Transportation (Sector 48) is a growing area, and with that I was interesting in taking a look at this sector more closely.

```{r RQ2DataSUN}
#Pull data for NAICS Industry Code = 48, Transporattion
CS_48<-CSData(industryCode = "48*")

#A succesful data pull returns a code of 200
```

Once data has bee pulled, it is wrangled and cleaned:  
```{r RQ2Summaries}
CS_48a<-CS_48 %>% 
  #Remove aggregated records from dataset where code =001 
  filter (VET_GROUP %in% c("002","003","004") )

#Count firms
CS_SubSectors<-CS_48a %>%      
    group_by(SUBSECTOR,VET_GROUP) %>% 
     summarize(TotFirms = sum(Firms))


#Show the distribition of business owners by veteran status

CS_SubSectorEmps<-CS_48a %>%      
    group_by(SUBSECTOR,VET_GROUP) %>% 
     summarize(TotEmps = sum(Employees)) %>% 

#Plot Firms
ggplot(CS_SubSectors, aes(SUBSECTOR,TotFirms,fill=VET_GROUP))+
  geom_col()+
     labs(title="Total Firms by Veteran Classification in Transporation Sector",
         x= "Industry NAICS Sector 2017",
         y= ("Number of Firms")) +
         scale_fill_discrete(name="Veteran Status",
                             labels=c("Veterans", "Vet/NonVet Partners", "NonVeterans"))+
      theme_minimal()
  
#Plot Employees
  ggplot(CS_SubSectorEmps, aes(SUBSECTOR,TotEmps,fill=VET_GROUP))+
  geom_col()+
     labs(title="Total Employees by Veteran Classification in Transporation Sector",
         x= "Industry NAICS Sector 2017",
         y= ("Number of Employees")) +
         scale_fill_discrete(name="Veteran Status",
                             labels=c("Veterans", "Vet/NonVet Partners", "NonVeterans"))+
      theme_minimal()

```
As shown, sector 484, Truck Transportation is the largest and as would be expected also has the most number of firms owned by veterans.

A Cross Tabulation of the number of firms owned by Veterans vs non by Sector

```{r RQ2Crosstab, warning=FALSE}

#Because  the returned data from the API 
#calls are already summarized, 
#we can display crosstabs using dplyr

#An alternaitve option is to use the reported 
# data to uncount and summarize, however this is memory
#intensive and unnecessary.
#Here is the alternate method:  
# b<-CS_48 %>% 
#  uncount(weights=.$Firms)
#  b
# table(b$SUBSECTOR,b$VET_GROUP)
#  remove(b)
 

# Cross Tab using dplyr code
#The spread() command is superceded, but seems
# to work very well here instead of pivot_wider.
a<-CS_48a %>% 
   group_by(SUBSECTOR,VET_GROUP) %>% 
   summarize(nFirms=sum(Firms)) %>% 
   spread(VET_GROUP,nFirms,sep="_") %>% 
   rename(NonVets= "VET_GROUP_002", "Vet/NonVet_Owners"= "VET_GROUP_003", "VETs" = "VET_GROUP_004") 
#Print the table

knitr::kable(a,caption="Crosstab Count of Firms by Veteran Status in Sector 48")
```

I decided to look at the pay rates within the transportation industry.  We can look to see if payrates  appear visually different to guide a deeper analysis. We will use the data that contains all vet status for owners. 


```{r RQ2PayRates, warning=FALSE}
# pay_df<-CS_48 %>% 
#   group_by(SUBSECTOR,VET_GROUP) %>% 
#     summarize(totpayroll= sum(Payroll), 
#               TotEmps=sum(Employees)) %>% 
#     mutate(AvgPayRate = (totpayroll*1000)/TotEmps) %>% 
#     filter(AvgPayRate!="NaN" & SUBSECTOR!="NA") %>% 
#     #simply to compare vet and not vet owner type firms 
#     filter(VET_GROUP %in% c("002","004"))
#Calculate avg annual pay by naics 4 digit code
pay_df2<-CS_48 %>%
    mutate(AvgAnnualPay= (Payroll*1000)/Employees) 

ggplot(pay_df2,aes(x=VET_GROUP,y=AvgAnnualPay)) +
     geom_boxplot(fill="#00AFBB")+
      theme_minimal()+
      labs(title="Mean and Spread of Average Annual Pay in NACICS 48- Transporation Industry", 
           subtitle= "Shown by Businesses Owner Veteran Status",
            x="Veteran Status",
            y="Average Annual Pay") +
       scale_x_discrete(labels=(c("Veterans", "Co-Vet/NonVet", "NonVeterans")))

# 
# 
# 
# #Create a plot summarize
# ggplot(pay_df,aes(x=SUBSECTOR,y=AvgPayRate)) +
#       geom_density(alpha=.05,aes(fill=VET_GROUP), position="stack")
#      # geom_boxplot(aes(color=VET_GROUP),fill="grey")
#    geom_point(aes(colour=VET_GROUP)) +
#        labs(title="Calculated Sector Payrate by Owner Type",
#             x="NAICS Subsector Within the Transporation Industry") +
#        scale_fill_discrete("Veteran Owners", "NonVeteran Owners")
# 
# 
# ggplot(pay_df,aes(x=VET_GROUP,y=AvgPayRate)) +
#      # geom_density(alpha=.05,aes(fill=VET_GROUP), position="stack")+
#      theme_minimal()+
#       labs(title="Mean and Spread of Average Annual Pay by Businesses Owned by Veterans and Nonveterans In The Transporation Sector",
#        x="NAICS Subsector Within the Transporation Industry")+
#    geom_boxplot(fill="#00AFBB")+
#    scale_fill_discrete(name="Veteran Status",
#                              labels=c("Veterans", "Vet/NonVet Partners", "NonVeterans"))

 
```

As the chart shows, the mean annual pay based on the data from 4-digit codes for all transportation businesses appears higher for veterans. 

__Exploration of Characteristics of Business (CB) Owners Data__  

The CB dataset allows us to better understand key attributes of business owners, for example whether businesses are family owned or franchised. These can be accessed by querying the specific survey question and their corresponding answers.  Given the structure of the dataset, it is necessary to know the survey question number to access this information.  My focus will be on family business characteristics which are captured in the ABS survey question labeled __"B02"__.  

To explore family business ownership, I started by looking at the number of firms owned by families across industry sectors to see if some sectors have higher percentage of family businesses.  

First we must pull data from teh CB endpoint. I will use the wildcard * input for the NAICS code, and retrieve data survey results from question B02.
```{r fambysectordata}
#Pull and wrangle family business data by sector
#The NAICS wildcard value is used to get all sectors
familypath<-CB_Path(bizAttrib = "B02" )
fambiz<-CB_Data(familypath)

#A code of 200 is returned if data is retreived,
```

As the analysis below shows, family owned businesses as a share of total sector business owners are highest in the NAICS sector 22 (accounting for 62% of owners, although the number of firms here is small), Sector 44, a much larger sector where family owners represent 36% or over 87,000 firms.  Similar high numbers of firms are in sectors, 53, and 56. 

```{r fambysectoranalysis}

fambiz2<- fambiz %>% 
       #Remove summary rows from aggregated data         
       filter(BUSCHAR %in% c("BM","BN")) 

t1<- pollster::crosstab(fambiz2, y=BUSCHAR_LABEL, x=SECTOR,weight=FIRMPDEMP)
knitr::kable(t1,caption = "Crosstab Summary of Percent Slit of Family Owned Businesses by Sector")

#For Family Owned Businesses:
 BM<-fambiz2 %>% filter(BUSCHAR == "BM")
 BN<-fambiz2 %>% filter(BUSCHAR == "BN")
# 
#Use pollster function to display crosstables
#For Family Owned Businesses:
t2<-pollster::topline(BM, variable =SECTOR,weight=FIRMPDEMP, valid_pct = FALSE,cum_pct = FALSE)
knitr::kable(t2, caption ="Count of Family Owned Businesses by Sector")
t2

# #For Non-Family Owned Businesses
t3<-pollster::topline(BN, variable =SECTOR,weight=FIRMPDEMP, valid_pct = FALSE,cum_pct = FALSE)
knitr::kable(t3, caption ="Count NonFamlily Owned Businesses by Sector")
t3
```

To allow for another look at the data, we are able to split the data further by sex, to see if there are notable differences overall in the number of family owned businesses by owner sex. 

Lets explore the number of family owned vs non-family owned businesses by owner sex (as defined as male, female, or equally share of owndership (male and female) ). Using the functions `CBDESCSexPath` and `CBQDESC_Sex` to pull by 2 modifications to the CB endpoint. The first modification references one of the questions asked on the survey, in this case the question related to family ownership. The second modification is to the categorical variable, sex.  

```{r FamOwnershipBySex}

# #Display Crosstab
ft1<-pollster::crosstab(fambiz2, y=SEX, x=SECTOR,weight=FIRMPDEMP)
ft1<-ft1 %>% rename("Females"="002", "Males"= "004", "Mixed"="003")

knitr::kable(ft1,caption="Overall split of Family Owned Businesses by Sex" )

#To unwieght the aggregated data for the geom_count plot. 
#This geom doesn not take stat=identity
b<-fambiz2%>% 
 uncount(weights=.$Firms)
 b

#Plot the difference in the number of firms owned by sex
ggplot(b,aes(SEX,SECTOR)) +
  geom_count(color="magenta") +
  labs(title= "Family Business Ownership by Sector & Owner Sex",
       subtitle = "Dot Size Represents # Firms",
       x= "Owner Sex",
       y= "Sector")+
    theme_light()


fam3<-FS_df2 %>% 
    select(SECTOR,SUBSECTOR, FIRMPDEMP,EMP,BUSCHAR, everything()) %>% 
     group_by(SECTOR,SEX,BUSCHAR) %>% 
    summarize(Firms = sum(FIRMPDEMP))
   # rename("Family_Firms"="BM", "NonFamily_Firms"="BN")
#Tables
fam3
#OR place these in nice tables using kable
t6<-pollster::crosstab_3way(fam3, y=BUSCHAR, x=SECTOR,z=SEX, weight=Firms, format = "wide")
knitr::kable(t6, caption = "Split of Firms by Sector, Sex and Business Classification")

```

Lastly, we can add one more endpoint modification to look at family business ownership, adding in veteran status as a classification variable.  Again, due to the nature of the returned data files, it is programatically easier to create a function for the additional endpoint modification using the VET_CODE variable..  

ADD ONE LAST PULL HERE!!! FIX THE CALL MAYBE MAKE THIS ABOUT FRANCISE? OWNEr VET STATUS NOT A PREDICATE

```{r VetsBYIndsuryandFamilyBiz old}
#THIS IS A GOOD GRAPH BUT NEEDS MORE DATA POINTS
vet_fam_path<-Get_CB_InQuVet_path(vetStatus = "all",bizAttrib = "B02", bizAnswer = "BM", industryCode = "*")
vet_fambiz_df<-GetandCleanCB(vet_fam_path)
vet_fam_biz2<-ChangeCBVarInQuVt(vet_fambiz_df)


# z<-pollster::topline(fambiz, variable =SECTOR,weight=FIRMPDEMP, valid_pct = FALSE,cum_pct = FALSE)
# rename(z,Industry=ResponsehFirms=Frequency)

#Prevent scientific notation
options(scipen=999)

#Calculate Payrates and remove NAs
h2<-vet_fam_biz2 %>% 
    mutate(payrate= PAYANN/EMP) %>% 
    filter(payrate!="NA")

#fix
g6<-ggplot(h2, aes(x=SECTOR,y=payrate)) 
g6
g6+ geom_half_boxplot(side="l", center = TRUE, outlier.color = "blue") +
  facet_wrap(~BUSCHAR)+
  coord_flip()

#USE THIS:
g7<-ggplot(h2, aes(x=BUSCHAR_LABEL,y=payrate)) 
g7+ geom_half_boxplot(side="l", center = TRUE, outlier.color = "blue") +
 geom_half_point() +
  facet_wrap(~SECTOR~VET_GROUP)+
   coord_flip()
  #theme_light()

#USE THIS:
g8<-ggplot(h2, aes(x=SECTOR,y=payrate)) 
g8+ geom_half_boxplot(side="l", center = TRUE, outlier.color = "blue") +
 geom_half_point() +
  facet_wrap(~VET_GROUP)+
   coord_flip()
  #theme_light()


#HEAT MAP, BUT NOT THE RIGHT DATA FOR THIS
plt<-ggplot(h2,aes(x=BUSCHAR,y=SECTOR,fill=EMP),na.rm=TRUE)
plt + geom_tile()

#THIS WORKS BUT WOULD BE BETTER WITH SECTOR DATA
# gqv<-ggplot(qv_df2, aes(y=Employees, x=BUSCHAR,fill=VET_GROUP))+
#   geom_col(stat="identity") +
#   labs(title = "Comparison of Firms by Employee Size",
#        subtitle= "Family Owned vs. Not-Family Owned Businesses") 
# gqv

```

-----------------



```{r}

# fambizCNT<-fambiz %>% 
#     filter(BUSCHAR %in% c("BM","BN"))    %>% 
#     select(SECTOR,SUBSECTOR, FIRMPDEMP,EMP,BUSCHAR, everything()) %>% 
#     summarize(Firms = sum(FIRMPDEMP))
# #Number of Firms responding to this survey question:
# sum(fambizCNT$Firms)
# 
# fam_by_sec<-fambiz %>% 
#       filter(BUSCHAR %in% c("BM","BN"))    %>% 
#      select(SECTOR,SUBSECTOR, FIRMPDEMP,EMP,BUSCHAR, everything()) %>% 
#      group_by(SECTOR, BUSCHAR) %>% 
#     summarize(Firms = sum(FIRMPDEMP))
# #Table
# fam_by_sec

#ambiz2<-fambiz %>%  filter(BUSCHAR %in% c("BM","BN")) 
#pollster::topline(fam_by_sec, variable =BUSCHAR_LABEL,weight=Firms, valid_pct = FALSE,cum_pct = FALSE)


#TWO WAY Crosstab, family owned by sex
# fambysec<- fambiz %>% 
#           filter(BUSCHAR %in% c("BM","BN") &
#              (SEX %in% c("002","003","004")) )
# pollster::crosstab(fam3, x=BUSCHAR_LABEL, y=SEX,weight=FIRMPDEMP)
# pollster::topline(fam3, variable =SEX,weight=FIRMPDEMP, valid_pct = FALSE,cum_pct = FALSE)

## 3 wAY TABLES
#By Sector and Sex



# sum(fam3$Firms)
# #By Sector  Sex & Vet Status
# #Sector and Sex
# fam4<-fambiz %>%
#       filter(BUSCHAR %in% c("BM","BN") &
#              (SEX %in% c("002","003","004")) &
#              (VET_GROUP %in% c("002","003","004"))) %>%
# 
#      select(SECTOR,SUBSECTOR, FIRMPDEMP,EMP,BUSCHAR, everything()) %>%
#      group_by(SECTOR,SEX,VET_GROUP) %>%
#     summarize(Firms = sum(FIRMPDEMP))
#     #spread(VET_GROUP,Firms,sep="_")
# 
# #CONVERT THIS DF TO PLOT:
# fam4


```


Looking at firm size by employees, and faceting by vet ownership.



```{r}
# qvpath<-CBQDESCVetPat(bizAttrib = "B02")
# qv_df<-CBQDESC_Vet(qvpath)
# 
# #Data is correct
# qv_df2<-qv_df %>% 
#   filter(VET_GROUP %in% c("002", "003", "004")) %>% 
#   filter(BUSCHAR %in% c("BN", "BM")) %>% 
#   group_by(VET_GROUP,BUSCHAR) %>% 
#    summarize(Employees=sum(EMP))
#    #spread(VET_GROUP,nFirms,sep="_")
# view(qv_df2)

# #Firm Size by Employee Distribution by Owner Type
# #options(scipen = 999)
# gq<-ggplot(qv_df2, aes(Employees, fill=BUSCHAR))+
#   geom_density() +
#   labs(title = "Comparison of Firms by Employee Size",
#        subtitle= "Family Owned vs. Not-Family Owned Businesses") 
# gq



# gqv<-ggplot(qv_df2, aes(Employees, fill=BUSCHAR))+
#   geom_col() +
#   labs(title = "Comparison of Firms by Employee Size",
#        subtitle= "Family Owned vs. Not-Family Owned Businesses")
# gqv
# 
```


Mod = 3
# ```{r warnings=FALSE}
# 
# vet_fambiz_path<-CBPath(vetStatus = "002",bizAttrib = "B02", bizAnswer = "BM")
# vet_fambiz_df<-CBSun(vet_fambiz_path)
# 
# # vf_df<-vet_fambiz_df %>% 
# #      select(SECTOR,SUBSECTOR, FIRMPDEMP,EMP,BUSCHAR, everything()) %>% 
# #     group_by(SECTOR) %>% 
# #    summarize(Firms = sum(FIRMPDEMP)) 
# #    # spread(BUSCHAR,Firms,sep="_")
# # #Table
# # vf_df
# # sum(vf_df$Firms)
# sum(vet_fambiz_df$FIRMPDEMP)
# 
# #or
# pollster::topline(vet_fambiz_df, variable =SECTOR,weight=FIRMPDEMP, valid_pct = FALSE,cum_pct = FALSE)
```


Individual Facets:



__Family Business by Industry and Vet:__



```{r warnings=FALSE}
# vet_fambiz_transp_path<-CBPath(vetStatus = "002",bizAttrib = "B02", bizAnswer = "BM", industryCode = "48*")
# vet_fambiz_transp<-CBSun(vet_fambiz_transp_path)
# 
# vfbt<-vet_fambiz_transp %>% 
#      select(SECTOR,SUBSECTOR, FIRMPDEMP,EMP,BUSCHAR, everything()) %>% 
#     group_by(SECTOR) %>% 
#    summarize(Firms = sum(FIRMPDEMP)) 
#    # spread(BUSCHAR,Firms,sep="_")
# vfbt
# sum(vfbt$Firms)


```






